<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Template</title>
</head>
<body>
    <div id="TemplateConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="newPlaylist">
                    <div class="inputContainer">
                        <label class="inputeLabel inputLabelUnfocused" for="playlistName">Playlist Name</label>
                        <input id="playlistName" name="playlistName" type="text" value="" is="emby-input" />
                    </div>
                    <div class="inputContainer">
                        <label class="inputeLabel inputLabelUnfocused" for="playlistUrl">Playlist URL</label>
                        <input id="playlistUrl" name="playlistUrl" type="text" value="" is="emby-input" />
                        <div class="fieldDescription">Another Description</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputeLabel inputLabelUnfocused" for="userAgent">Custom User-Agent</label>
                        <input id="userAgent" name="userAgent" type="text" value="" is="emby-input" />
                        <div class="fieldDescription">Another Description</div>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save List</span>
                        </button>
                    </div>
                </form>
                <br />
                <form id="playlistSelectionForm">
                    <div class="selectContainer">
                        <label class="selectLabel" for="playlistSelection">Pick a playlist to load channels from</label>
                        <select is="emby-select" id="playlistSelection" name="playlistSelection" class="emby-select-withcolor emby-select">
                        </select>
                        <div id="playlistDesc" class="fieldDescription"></div>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Load Channels</span>
                        </button>
                    </div>
                </form>
                <br />
                <form id="channelSelectionForm">
                    <input type="hidden" id="channelSelectionPlaylist" name="channelSelectionPlaylist" value="">
                    <div class="selectContainer">
                        <label class="selectLabel" for="channelSelection">Pick a channel to load the data of</label>
                        <select is="emby-select" id="channelSelection" name="channelSelection" class="emby-select-withcolor emby-select">
                        </select>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Load Channel</span>
                        </button>
                    </div>
                </form>
                <br />
                <form id="channelAttributeForm">
                    <input type="hidden" id="channelAttrSelectionPlaylist" name="channelAttrSelectionPlaylist" value="">
                    <div class="inputContainer">
                        <label class="inputeLabel inputLabelUnfocused" for="channelName">Channel name</label>
                        <input id="channelName" name="channelName" type="text" is="emby-input" />
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="attrSelection">Pick an attribute of the channel to edit</label>
                        <select is="emby-select" id="attrSelection" name="attrSelection" class="emby-select-withcolor emby-select">
                        </select>
                    </div>
                    <div class="inputContainer">
                        <label class="inputeLabel inputLabelUnfocused" for="channelAttr">Attribute value</label>
                        <input id="channelAttr" name="channelAttr" type="text" is="emby-input" />
                    </div>
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="hideChannel" name="hideChannel" type="checkbox" is="emby-checkbox" />
                            <span>Hide channel</span>
                        </label>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save Channel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">

            var curChannel = null;
            var apiKey = null;

            function getM3UUrl() {
                return "Import url: " + ApiClient.getUrl('M3UEditor/GetM3UList?Id=' + encodeURI(btoa(document.querySelector("#playlistSelection").value)) + "&key=" + encodeURI(apiKey));
            }

            function loadPlaylists() {
                var request = {
                    url: ApiClient.getUrl('M3UEditor/GetPlaylists'),
                    type: 'POST',
                    contentType: 'application/json',
                    dataType: "json"
                };

                ApiClient.fetch(request).then(data => {
                    var introSelect = document.getElementById("playlistSelection");
                    introSelect.innerHTML = '';
                    for (var i = 0; i < data.length; i++) {
                        var item = document.createElement("option");
                        item.text = data[i].PlaylistName;
                        item.value = data[i].PlaylistUrl;
                        introSelect.appendChild(item);
                    }
                    document.querySelector("#playlistDesc").innerHTML = getM3UUrl();
                    Dashboard.hideLoadingMsg();
                }).catch(function (error) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert({
                        message: error.stack
                    });

                });
            }

            function getApiKey() {
                var request = {
                    url: ApiClient.getUrl('M3UEditor/GetApiKey'),
                    type: 'POST',
                    contentType: 'application/json',
                    dataType: "json"
                };

                ApiClient.fetch(request).then(data => {
                    apiKey = data.key;
                    if (document.querySelector("#playlistSelection").value.length > 0)
                        document.querySelector("#playlistDesc").innerHTML = getM3UUrl();
                    Dashboard.hideLoadingMsg();
                }).catch(function (error) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert({
                        message: error.stack
                    });

                });
            }

            getApiKey();
            loadPlaylists();

            document.querySelector("#attrSelection").addEventListener('change', function (event) {
                console.log(curChannel.Attributes[document.querySelector("#attrSelection").value]);
                document.querySelector("#channelAttr").value = curChannel.Attributes[document.querySelector("#attrSelection").value];
            });

            document.querySelector("#playlistSelection").addEventListener('change', function (event) {
                document.querySelector("#playlistDesc").innerHTML = getM3UUrl();
            });

            document.querySelector("#channelName").addEventListener('change', function (event) {
                if (curChannel == null)
                    return;
                curChannel.Name = document.querySelector("#channelName").value;
            });

            document.querySelector("#channelAttr").addEventListener('change', function (event) {
                if (curChannel == null)
                    return;
                curChannel.Attributes[document.querySelector('#attrSelection').value] = document.querySelector("#channelAttr").value;
            });

            document.querySelector("#hideChannel").addEventListener('change', function (event) {
                if (curChannel == null)
                    return;
                curChannel.hidden = document.querySelector("#hideChannel").checked;
            });

            document.querySelector('#channelAttributeForm').addEventListener('submit', function (event) {
                Dashboard.showLoadingMsg();
                var query_data = {
                    channel: curChannel,
                    PlaylistUrl: document.querySelector('#channelAttrSelectionPlaylist').value
                };

                console.log(JSON.stringify(query_data));

                var request = {
                    url: ApiClient.getUrl('M3UEditor/SaveChannel'),
                    type: 'POST',
                    data: JSON.stringify(query_data),
                    contentType: 'application/json'
                };

                ApiClient.fetch(request).then(data => {
                    Dashboard.hideLoadingMsg();
                }).catch(function (error) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert({
                        message: error.stack
                    });
                });

                event.preventDefault();
                return false;
            });

            document.querySelector('#channelSelectionForm').addEventListener('submit', function (event) {
                Dashboard.showLoadingMsg();
                var query_data = {
                    m3UChannelId: document.querySelector('#channelSelection').value,
                    PlaylistUrl: document.querySelector('#channelSelectionPlaylist').value
                };

                var request = {
                    url: ApiClient.getUrl('M3UEditor/GetChannel'),
                    type: 'POST',
                    data: JSON.stringify(query_data),
                    dataType: "json",
                    contentType: 'application/json'
                };

                ApiClient.fetch(request).then(data => {
                    curChannel = data;
                    var introSelect = document.getElementById("attrSelection");
                    introSelect.innerHTML = '';

                    if (curChannel.Attributes["tvg-chno"] == undefined)
                        curChannel.Attributes["tvg-chno"] = '';

                    for (const [key, value] of Object.entries(curChannel.Attributes)) {
                        console.log(`${key}: ${value}`);
                        var item = document.createElement("option");
                        item.text = key;
                        item.value = key;
                        introSelect.appendChild(item);
                    }

                    document.querySelector('#hideChannel').checked = curChannel.hidden;
                    document.querySelector('#channelName').value = curChannel.Name;
                    document.querySelector('#channelAttrSelectionPlaylist').value = query_data.PlaylistUrl;
                    Dashboard.hideLoadingMsg();
                }).catch(function (error) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert({
                        message: error.stack
                    });
                });

                event.preventDefault();
                return false;
            });

            document.querySelector('#playlistSelectionForm').addEventListener('submit', function (event) {
                Dashboard.showLoadingMsg();
                var query_data = {
                    PlaylistUrl: document.querySelector('#playlistSelection').value
                };

                var request = {
                    url: ApiClient.getUrl('M3UEditor/GetChannels'),
                    type: 'POST',
                    data: JSON.stringify(query_data),
                    dataType: "json",
                    contentType: 'application/json'
                };

                ApiClient.fetch(request).then(data => {
                    document.getElementById('channelSelectionPlaylist').value = query_data.PlaylistUrl;
                    var introSelect = document.getElementById("channelSelection");
                    introSelect.innerHTML = '';
                    for (var i = 0; i < data.length; i++) {
                        var item = document.createElement("option");
                        if (data[i].Hidden) {
                            item.text = "[HIDDEN] " + data[i].Name;
                        } else {
                            item.text = data[i].Name;
                        }
                 
                        item.value = data[i].Id;
                        introSelect.appendChild(item);
                    }
                    Dashboard.hideLoadingMsg();
                }).catch(function (error) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert({
                        message: error.stack
                    });
                });

                event.preventDefault();
                return false;
            });

            document.querySelector('#newPlaylist').addEventListener('submit', function (event) {
                Dashboard.showLoadingMsg();

                var query_data = {
                    PlaylistName: document.querySelector('#playlistName').value,
                    PlaylistUrl: document.querySelector('#playlistUrl').value,
                    UserAgent: document.querySelector('#userAgent').value
                };

                var request = {
                    url: ApiClient.getUrl('M3UEditor/AddPlaylist'),
                    type: 'POST',
                    data: JSON.stringify(query_data),
                    dataType: "json",
                    contentType: 'application/json'
                };

                ApiClient.fetch(request).then(data => {
                    if (data.ErrorCode == null) {
                        var introSelect = document.getElementById("playlistSelection");
                        introSelect.innerHTML = '';
                        for (var i = 0; i < data.length; i++) {
                            var item = document.createElement("option");
                            item.text = data[i].PlaylistName;
                            item.value = data[i].PlaylistUrl;
                            introSelect.appendChild(item);
                        }
                    } else {
                        alert(data.ErrorMsg);
                    }
                    Dashboard.hideLoadingMsg();
                }).catch(function (error) {
                    Dashboard.hideLoadingMsg();
                        Dashboard.alert({
                            message: error.stack
                        });

                    });

                event.preventDefault();
                return false;
            });
        </script>
    </div>
</body>
</html>